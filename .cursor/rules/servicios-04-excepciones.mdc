---
description: Manejo de excepciones personalizadas con c√≥digos de error estandarizados
globs: ["**/exception/**/*.java", "**/controller/ExceptionHandlerController.java"]
alwaysApply: true
---

# ‚ö†Ô∏è Manejo de Excepciones Personalizadas

## üìã TL;DR

- ‚úÖ Una excepci√≥n personalizada por funcionalidad
- ‚úÖ C√≥digo de error formato: `TDTC-XX-NNNN`
- ‚úÖ Constantes en `Constants.java`
- ‚úÖ Handler en `ExceptionHandlerController`
- ‚úÖ **Para m√≥dulos completos:** Organizar en `exception/{modulo}/`
- ‚ùå NO usar excepciones gen√©ricas

## üö® Reglas Principales

1. Cada funcionalidad tiene su propia excepci√≥n (`*Exception extends RuntimeException`)
2. Incluir campo `errorCode` con formato `TDTC-XX-NNNN`
3. Dos constructores: simple (mensaje + c√≥digo) y con causa (mensaje + c√≥digo + Throwable)
4. Constantes de mensajes y c√≥digos en `Constants.java`
5. Handler espec√≠fico en `ExceptionHandlerController` con `@ExceptionHandler`
6. **Para m√≥dulos completos:** Organizar en `exception/{modulo}/` (ver Organizaci√≥n Modular)

## üìä Referencia R√°pida - Formato de C√≥digos

| M√≥dulo | Prefijo | Ejemplo | Descripci√≥n |
|--------|---------|---------|-------------|
| Short URL | `TDTC-SU-` | `TDTC-SU-0001` | Errores de acortamiento de URLs |
| Transaction | `TDTC-TX-` | `TDTC-TX-0001` | Errores de transacciones |
| Cumulus | `TDTC-CU-` | `TDTC-CU-0001` | Errores de c√∫mulos/acumulaci√≥n |
| Parameter | `TDTC-PA-` | `TDTC-PA-0001` | Errores de parametrizaci√≥n |

**Formato**: `TDTC-XX-NNNN`
- `TDTC` = Tienda Digital Transaccional Comunes
- `XX` = Identificador del m√≥dulo (2 letras)
- `NNNN` = N√∫mero secuencial (4 d√≠gitos: 0001, 0002, ...)

## ‚úÖ Ejemplos

### Ejemplo 1: Crear Excepci√≥n Personalizada

```java
package com.bolivar.tienda.digital.transaccional.comunes.ms.exception;

import lombok.Getter;

/**
 * Excepci√≥n personalizada para operaciones de acortamiento de URLs.
 * Se lanza cuando ocurren errores en el proceso de acortamiento de URLs,
 * tales como errores de parametrizaci√≥n, servicio externo o almacenamiento.
 *
 * @author Team Tienda Digital
 * @since 1.0.0
 */
@Getter
public class ShortUrlException extends RuntimeException {

    /**
     * C√≥digo de error espec√≠fico de la excepci√≥n
     */
    private final String errorCode;

    /**
     * Constructor para crear una excepci√≥n con mensaje y c√≥digo de error.
     *
     * @param message Mensaje descriptivo del error
     * @param errorCode C√≥digo de error espec√≠fico (ver Constants.CODE_*)
     */
    public ShortUrlException(String message, String errorCode) {
        super(message);
        this.errorCode = errorCode;
    }

    /**
     * Constructor para crear una excepci√≥n con mensaje, c√≥digo de error y causa.
     *
     * @param message Mensaje descriptivo del error
     * @param errorCode C√≥digo de error espec√≠fico (ver Constants.CODE_*)
     * @param cause Excepci√≥n original que caus√≥ este error
     */
    public ShortUrlException(String message, String errorCode, Throwable cause) {
        super(message, cause);
        this.errorCode = errorCode;
    }
}
```

### Ejemplo 2: Definir Constantes

```java
public class Constants {
    
    // Short URL - Error Messages
    public static final String ERROR_SHORT_URL_SAVE = "Error al guardar URL acortada en base de datos";
    public static final String ERROR_SHORT_URL_EXTERNAL_SERVICE = "Error al llamar servicio externo de acortamiento";
    public static final String ERROR_SHORT_URL_PARAMETRIZACION = "Error al resolver par√°metros de configuraci√≥n";
    
    // Short URL - Error Codes
    public static final String CODE_PARAMETRIZACION_NOT_FOUND = "TDTC-SU-0001";
    public static final String CODE_EXTERNAL_SERVICE_ERROR = "TDTC-SU-0002";
    public static final String CODE_DATABASE_ERROR = "TDTC-SU-0003";
}
```

### Ejemplo 3: Usar en Servicios

```java
@Override
public String shortenUrl(String longUrl, String idSistema, Integer dias) {
    try {
        ExternalShortUrlResponseDto response = urlShortenerClient.shortenUrl(buildRequest(longUrl, idSistema, dias));
        validateExternalResponse(response);
        return response.getShortUrl();
        
    } catch (ShortUrlException e) {
        throw e; // ‚úÖ Relanzar excepciones de negocio
    } catch (Exception e) {
        // ‚úÖ Envolver excepciones t√©cnicas con contexto
        throw new ShortUrlException(
            Constants.ERROR_SHORT_URL_EXTERNAL_SERVICE + ": " + e.getMessage(),
            Constants.CODE_EXTERNAL_SERVICE_ERROR, e
        );
    }
}
```

### Ejemplo 4: Handler en Controller

```java
@ExceptionHandler({ShortUrlException.class})
public Response<Object> shortUrlException(ShortUrlException e, HttpServletRequest request) {
    log.error("ShortUrlException: Url Request: {} | ErrorCode: {} | Message: {} ", 
            request.getRequestURI(), e.getErrorCode(), e.getMessage());

    String messageWithCode = String.format("[%s] %s", e.getErrorCode(), e.getMessage());

    return Response.builder()
            .failure(true)
            .code(HttpStatus.BAD_REQUEST.value())
            .message(messageWithCode)
            .timestamp(String.valueOf(System.currentTimeMillis()))
            .build();
}
```

## üö´ Restricciones

1. **NO** usar excepciones gen√©ricas (`RuntimeException`, `Exception`)
2. **NO** hardcodear mensajes de error en el c√≥digo
3. **NO** omitir el campo `errorCode`
4. **NO** perder contexto de la causa ra√≠z (pasar `Throwable cause`)
5. **NO** envolver excepciones de negocio (relanzarlas sin modificar)
6. **NO** omitir logs en puntos de lanzamiento de excepciones
7. **NO** usar c√≥digos de error sin formato est√°ndar
8. **NO** duplicar c√≥digos de error entre m√≥dulos
9. **NO** omitir JavaDoc en excepciones personalizadas
10. **NO** retornar null en lugar de lanzar excepci√≥n
11. **NO** crear excepciones de m√≥dulos completos en la ra√≠z de `exception/`

## üì¶ Organizaci√≥n Modular de Excepciones

### Cu√°ndo Usar Paquetes Espec√≠ficos

| Criterio | Ra√≠z `exception/` | Paquete `exception/{modulo}/` |
|----------|-------------------|-------------------------------|
| Excepci√≥n transversal | ‚úÖ S√≠ (ej: `AllieException`) | ‚ùå No |
| Excepci√≥n de m√≥dulo simple | ‚úÖ S√≠ (ej: `CipherException`) | ‚ùå No |
| **Excepci√≥n de m√≥dulo completo** | ‚ùå No | ‚úÖ S√≠ (controller + service + dto) |
| M√∫ltiples excepciones relacionadas | ‚ùå No | ‚úÖ S√≠ (agrupar en paquete) |

**Estructura Modular:**
```
exception/
‚îú‚îÄ‚îÄ {modulo}/
‚îÇ   ‚îî‚îÄ‚îÄ {Modulo}Exception.java
‚îî‚îÄ‚îÄ ExceptionHandlerController.java (ra√≠z, handler global)
```

**Import correcto:**
```java
// ‚úÖ CORRECTO: Import desde paquete espec√≠fico
import com.bolivar.tiendaseguros.ms.exception.processconfig.ProcessConfigurationException;
```

## ‚úÖ Validaci√≥n Autom√°tica

Cursor debe detectar:

- ‚ùå `throw new RuntimeException(...)` en servicios
- ‚ùå Mensajes hardcodeados: `throw new Exception("Error al...")`
- ‚ùå Excepciones sin campo `errorCode`
- ‚ùå C√≥digos de error sin formato `TDTC-XX-NNNN`
- ‚ùå Falta de `@ExceptionHandler` para excepciones personalizadas
- ‚ùå Handlers que no loguean c√≥digo de error
- ‚ùå Excepciones sin JavaDoc
- ‚ùå Constructor sin par√°metro `Throwable cause`

## üéØ Objetivo + Regla de Oro

**Objetivo**: Manejo consistente de errores con trazabilidad completa mediante c√≥digos √∫nicos y contexto detallado.

**REGLA DE ORO**: "Una excepci√≥n por funcionalidad con c√≥digo `TDTC-XX-NNNN`. Relanzar excepciones de negocio, envolver t√©cnicas. Siempre incluir causa original."


> **Ver tambi√©n**: 
> - [servicios-01-creacion-servicios.mdc](./servicios-01-creacion-servicios.mdc) - Uso en servicios
