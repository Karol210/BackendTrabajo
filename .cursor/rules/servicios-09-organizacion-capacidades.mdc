---
description: OrganizaciÃ³n por capacidades en servicios externos, DTOs y Mappers
globs: ["**/service/**/external/**/*.java", "**/dto/**/*.java", "**/mapper/**/*.java"]
alwaysApply: true
---

# ğŸ—‚ï¸ OrganizaciÃ³n por Capacidades - Servicios, DTOs y Mappers

## ğŸ“‹ TL;DR

- âœ… SeparaciÃ³n por capacidad: `external/auth/`, `dto/{dominio}/auth/`, `mapper/{dominio}/auth/`
- âœ… Estructura paralela: service â†’ dto â†’ mapper con misma organizaciÃ³n
- âœ… Alta cohesiÃ³n y bajo acoplamiento por carpeta
- âœ… Subcapacidades (>50 lÃ­neas) para responsabilidades independientes
- âŒ NO mezclar capacidades ni crear estructura inconsistente

## ğŸš¨ Reglas Principales

1. **SeparaciÃ³n por Capacidad**: Cada capacidad tiene su propia carpeta en `external/`, `dto/` y `mapper/` con nombres descriptivos (`auth`, `questions`, `validation`)
2. **CohesiÃ³n Alta**: Todos los archivos relacionados con una capacidad juntos (Client, Service, ServiceImpl, DTOs, Mapper)
3. **Estructura Paralela**: `service/{dominio}/{capacidad}/` se refleja en `dto/{dominio}/{capacidad}/` y `mapper/{dominio}/{capacidad}/`
4. **Escalabilidad**: Agregar nuevas capacidades solo requiere crear carpeta sin afectar existentes
5. **Subcapacidades**: Para responsabilidades independientes (>50 lÃ­neas), usar subcarpetas (`validation/rules/`, `validation/storage/`)

## ğŸ“Š Referencia RÃ¡pida

### DecisiÃ³n de OrganizaciÃ³n

| Criterio | RaÃ­z `external/` | Subcarpeta `external/{capacidad}/` |
|----------|:----------------:|:---------------------------------:|
| Una sola capacidad | âœ… SÃ­ | âŒ No (sobrecarga innecesaria) |
| MÃºltiples capacidades (â‰¥2) | âŒ No | âœ… SÃ­ (mejor organizaciÃ³n) |
| Capacidades independientes | âŒ No | âœ… SÃ­ (bajo acoplamiento) |
| Funcionalidades relacionadas | âœ… SÃ­ | âŒ No |

### Patrones Comunes de Capacidades

| Capacidad | Responsabilidad | Archivos en carpeta | Archivos en `dto/` | ExposiciÃ³n |
|-----------|-----------------|---------------------|-------------------|:----------:|
| `auth` | AutenticaciÃ³n y autorizaciÃ³n | `*AuthClient`, `*AuthService`, `*AuthServiceImpl` | `*TokenDto`, `*CredentialsDto` | âŒ Interna |
| `questions` | Consulta de datos | `*QuestionsClient`, `*QuestionsService`, `*QuestionsServiceImpl` | `*RequestDto`, `*ResponseDto` | âŒ Interna |
| `validation` | ValidaciÃ³n de reglas | `*ValidationClient`, `*ValidationService`, `*ValidationServiceImpl` | `*ValidationRequestDto`, `*ResultDto` | âŒ Interna |
| `processing` | Procesamiento de transacciones | `*ProcessingClient`, `*ProcessingService`, `*ProcessingServiceImpl` | `*ProcessRequestDto`, `*ProcessResponseDto` | âŒ Interna |
| `storage` | Almacenamiento de datos | `*StorageService`, `*StorageServiceImpl` | Opcional segÃºn caso | âŒ Interna |
| `rules` | Reglas de negocio | `*RulesService`, `*RulesServiceImpl` | Ninguno (usa DTOs existentes) | âŒ Interna |
| `organization` | Ordenar/agrupar datos | `*OrganizationService`, `*OrganizationServiceImpl` | Ninguno (usa DTOs existentes) | âŒ Interna (ver regla 01) |

### Subcapacidades - OrganizaciÃ³n Anidada

**CuÃ¡ndo Usar Subcapacidades:**
- âœ… Un mÃ³dulo tiene mÃºltiples responsabilidades bien definidas
- âœ… Cada subcapacidad tiene lÃ³gica significativa (>50 lÃ­neas)
- âœ… Las responsabilidades son independientes entre sÃ­
- âŒ NO crear subcapacidades si solo hay mÃ©todos pequeÃ±os (mantener en un servicio)

| Nivel | Uso | Ejemplo |
|---|---|---|
| **MÃ³dulo Principal** | Coordinador de flujo | `validation/InsurabilityValidationServiceImpl` |
| **Subcapacidad 1** | Responsabilidad especÃ­fica | `validation/rules/InsurabilityValidationRulesServiceImpl` |
| **Subcapacidad 2** | Responsabilidad especÃ­fica | `validation/storage/InsurabilityValidationStorageServiceImpl` |

### OrganizaciÃ³n de Mappers

| UbicaciÃ³n Servicio | UbicaciÃ³n Mapper | Ejemplo |
|-------------------|------------------|---------|
| `service/{dominio}/` | `mapper/{dominio}/` | `service/premiumCalculation/` â†’ `mapper/PremiumCalculationMapper` |
| `service/{dominio}/{capacidad}/` | `mapper/{dominio}/{capacidad}/` | `service/insurability/validation/` â†’ `mapper/insurability/validation/InsurabilityValidationMapper` |
| `service/{dominio}/external/{capacidad}/` | `mapper/{dominio}/{capacidad}/` | `service/insurability/external/auth/` â†’ `mapper/insurability/auth/AuthMapper` |

**Reglas de Mappers:**
- âœ… Mapper sigue la estructura de carpetas del servicio/dominio
- âœ… Nomenclatura: `{Dominio}{Capacidad}Mapper` (ej: `InsurabilityValidationMapper`)
- âœ… AnotaciÃ³n `@Component` para inyecciÃ³n de dependencias
- âœ… MÃ©todos pÃºblicos para transformaciones principales, privados para auxiliares
- âŒ NO crear mappers en raÃ­z de `mapper/` si el servicio tiene subcarpetas
- âŒ NO duplicar lÃ³gica de mapeo entre servicios (crear mapper compartido si es necesario)

### Beneficios de OrganizaciÃ³n por Capacidades

| Beneficio | Impacto |
|-----------|---------|
| **Alta CohesiÃ³n** | Archivos relacionados juntos (`external/auth/` agrupa todo lo de autenticaciÃ³n) |
| **Bajo Acoplamiento** | Cambios en `auth/` no afectan `questions/` |
| **Escalabilidad** | Agregar `validation/` sin tocar cÃ³digo existente |
| **Mantenibilidad** | Desarrolladores encuentran cÃ³digo rÃ¡pidamente |
| **Testing** | Tests separados por capacidad (`AuthServiceTest`, `QuestionsServiceTest`) |

## âœ… Ejemplos

### Ejemplo 1: Estructura Completa por Capacidades - Insurability

```
service/insurability/
â”œâ”€â”€ external/
â”‚   â”œâ”€â”€ auth/                                    ğŸ” Capacidad: AutenticaciÃ³n OAuth2
â”‚   â”‚   â”œâ”€â”€ CognitoAuthClient.java              (Feign Client para Cognito)
â”‚   â”‚   â”œâ”€â”€ CognitoAuthService.java             (Interface)
â”‚   â”‚   â””â”€â”€ CognitoAuthServiceImpl.java         (ImplementaciÃ³n)
â”‚   â”‚
â”‚   â””â”€â”€ questions/                               ğŸ“‹ Capacidad: Consultas de Preguntas
â”‚       â”œâ”€â”€ ExternalInsurabilityQuestionsClient.java
â”‚       â”œâ”€â”€ ExternalInsurabilityQuestionsService.java
â”‚       â””â”€â”€ ExternalInsurabilityQuestionsServiceImpl.java
â”‚
â”œâ”€â”€ organization/                                 ğŸ“Š Capacidad: OrganizaciÃ³n (USO INTERNO)
â”‚   â”œâ”€â”€ InsurabilityQuestionsOrganizationService.java       (Interface)
â”‚   â””â”€â”€ InsurabilityQuestionsOrganizationServiceImpl.java   (ImplementaciÃ³n)
â”‚
â”œâ”€â”€ validation/                                  âœ… Capacidad: ValidaciÃ³n (con subcapacidades)
â”‚   â”œâ”€â”€ InsurabilityValidationService.java      (Interface principal)
â”‚   â”œâ”€â”€ InsurabilityValidationServiceImpl.java  (Coordinador - 68 lÃ­neas)
â”‚   â”‚
â”‚   â”œâ”€â”€ rules/                                   ğŸ“‹ Subcapacidad: Reglas de Negocio
â”‚   â”‚   â”œâ”€â”€ InsurabilityValidationRulesService.java
â”‚   â”‚   â””â”€â”€ InsurabilityValidationRulesServiceImpl.java
â”‚   â”‚
â”‚   â””â”€â”€ storage/                                 ğŸ’¾ Subcapacidad: Almacenamiento
â”‚       â”œâ”€â”€ InsurabilityValidationStorageService.java
â”‚       â””â”€â”€ InsurabilityValidationStorageServiceImpl.java
â”‚
â”œâ”€â”€ InsurabilityQuestionsService.java            (Service Principal)
â””â”€â”€ InsurabilityQuestionsServiceImpl.java        (Orquesta capacidades)

dto/insurability/
â”œâ”€â”€ auth/                                        ğŸ” DTOs de AutenticaciÃ³n
â”‚   â””â”€â”€ CognitoTokenResponseDto.java            (Token OAuth2)
â”‚
â”œâ”€â”€ questions/                                   ğŸ“‹ DTOs de Preguntas
â”‚   â”œâ”€â”€ InsurabilityQuestionsRequestDto.java
â”‚   â”œâ”€â”€ InsurabilityQuestionDto.java
â”‚   â””â”€â”€ InsurabilityQuestionsResponseDto.java
â”‚
â”œâ”€â”€ validation/                                  âœ… DTOs de ValidaciÃ³n
â”‚   â”œâ”€â”€ InsurabilityValidationRequestDto.java
â”‚   â”œâ”€â”€ InsurabilityValidationResponseDto.java
â”‚   â”œâ”€â”€ PersonValidationDto.java
â”‚   â””â”€â”€ QuestionValidationDto.java
â”‚
â””â”€â”€ (raÃ­z)                                       ğŸ’¾ DTOs de Guardar
    â”œâ”€â”€ FormDto.java
    â”œâ”€â”€ InsurabilityRequestDto.java
    â””â”€â”€ InsurabilityResponseDto.java

mapper/insurability/
â”œâ”€â”€ validation/                                  âœ… Mapper de ValidaciÃ³n
â”‚   â””â”€â”€ InsurabilityValidationMapper.java       (Transforma DTOs a estructuras de persistencia)
â”‚
â””â”€â”€ (raÃ­z - si hay mappers generales del dominio)
    â””â”€â”€ InsurabilityMapper.java                 (Transformaciones comunes del dominio)

âš ï¸ NOTA: La capacidad `organization` NO requiere DTOs propios, 
usa los DTOs existentes de otras capacidades.
```

### Ejemplo 2: DecisiÃ³n - Subcarpetas vs RaÃ­z + Agregar Capacidad

**Escenario A: Una Sola Capacidad - RaÃ­z es Suficiente**
```
service/email/external/
â”œâ”€â”€ ExternalEmailClient.java      âœ… Simple - una sola responsabilidad
â”œâ”€â”€ ExternalEmailService.java
â””â”€â”€ ExternalEmailServiceImpl.java
```

**Escenario B: MÃºltiples Capacidades - Usar Subcarpetas**
```
service/insurability/external/
â”œâ”€â”€ auth/                          âœ… Capacidad 1: AutenticaciÃ³n
â”‚   â”œâ”€â”€ CognitoAuthClient.java
â”‚   â””â”€â”€ CognitoAuthServiceImpl.java
â””â”€â”€ questions/                     âœ… Capacidad 2: Consultas
    â”œâ”€â”€ ExternalInsurabilityQuestionsClient.java
    â””â”€â”€ ExternalInsurabilityQuestionsServiceImpl.java
```

**Escenario C: Agregar Nueva Capacidad sin Afectar Existentes**
```
service/insurability/external/
â”œâ”€â”€ auth/           (existente - intacto)
â”œâ”€â”€ questions/      (existente - intacto)
â””â”€â”€ validation/     âœ… Nueva capacidad
    â”œâ”€â”€ ExternalValidationClient.java
    â””â”€â”€ ExternalValidationServiceImpl.java

dto/insurability/
â”œâ”€â”€ auth/           (existente - intacto)
â”œâ”€â”€ questions/      (existente - intacto)
â””â”€â”€ validation/     âœ… DTOs correspondientes
    â”œâ”€â”€ ValidationRequestDto.java
    â””â”€â”€ ValidationResponseDto.java
```

**Uso en servicio principal:**
```java
@Service
@RequiredArgsConstructor
public class InsurabilityQuestionsServiceImpl implements InsurabilityQuestionsService {
    private final CognitoAuthService cognitoAuthService;              // Existente
    private final ExternalInsurabilityQuestionsService questionsService; // Existente
    private final ExternalValidationService validationService;        // âœ… Nueva - sin modificar cÃ³digo anterior
}
```

### Ejemplo 3: Subcapacidades - Coordinador que Delega Responsabilidades

**Estructura con Subcapacidades:**
```
service/insurability/validation/
â”œâ”€â”€ InsurabilityValidationService.java          (Interface principal)
â”œâ”€â”€ InsurabilityValidationServiceImpl.java      (Coordinador - delega a subcapacidades)
â”‚
â”œâ”€â”€ rules/                                       ğŸ“‹ Subcapacidad: Reglas de Negocio
â”‚   â”œâ”€â”€ InsurabilityValidationRulesService.java
â”‚   â””â”€â”€ InsurabilityValidationRulesServiceImpl.java
â”‚
â””â”€â”€ storage/                                     ğŸ’¾ Subcapacidad: Almacenamiento
    â”œâ”€â”€ InsurabilityValidationStorageService.java
    â””â”€â”€ InsurabilityValidationStorageServiceImpl.java

test/.../validation/
â”œâ”€â”€ rules/
â”‚   â””â”€â”€ InsurabilityValidationRulesServiceImplTest.java    (12 tests)
â””â”€â”€ storage/
    â””â”€â”€ InsurabilityValidationStorageServiceImplTest.java  (6 tests)
```

**Servicio Coordinador (Principal):**
```java
@Service
@RequiredArgsConstructor
public class InsurabilityValidationServiceImpl implements InsurabilityValidationService {
    
    private final InsurabilityValidationRulesService rulesService;      // âœ… Subcapacidad: rules
    private final InsurabilityValidationStorageService storageService;  // âœ… Subcapacidad: storage
    private final InsurabilityValidationMapper mapper;

    @Override
    public InsurabilityValidationResponseDto validateInsurabilityDeclaration(
            InsurabilityValidationRequestDto request) {
        
        // 1. Validar request (delegado a rules)
        rulesService.validateRequest(request);
        
        // 2. Validar asegurabilidad (delegado a rules)
        boolean isInsurable = rulesService.validatePersonsInsurability(request);
        
        // 3. Transformar datos (mapper)
        Map<String, Object> stepData = mapper.buildStepData(request.getPersons(), isInsurable);
        
        // 4. Guardar en transacciÃ³n (delegado a storage)
        storageService.saveValidationStep(stepData);
        
        return InsurabilityValidationResponseDto.builder()
                .insurable(isInsurable)
                .build();
    }
}
```

**Beneficios de Subcapacidades:**
- âœ… **Coordinador limpio**: 68 lÃ­neas vs 126 lÃ­neas originales (46% reducciÃ³n)
- âœ… **Alta cohesiÃ³n**: Cada subcapacidad tiene una responsabilidad Ãºnica
  - `rules/`: Solo validaciones de negocio
  - `storage/`: Solo persistencia
- âœ… **Testeable**: 18 tests especÃ­ficos (12 rules + 6 storage) vs tests acoplados
- âœ… **Reutilizable**: `rules/` puede usarse sin `storage/` si es necesario
- âœ… **Escalable**: Agregar nueva subcapacidad sin modificar existentes

**CuÃ¡ndo NO crear subcapacidades:**
- âŒ MÃ©todos pequeÃ±os (< 50 lÃ­neas cada uno)
- âŒ LÃ³gica fuertemente acoplada que no se puede separar
- âŒ Solo 1-2 mÃ©todos auxiliares (usar mÃ©todos privados)

**Nota sobre Mappers:** Siguen estructura paralela al servicio. Ver tabla "OrganizaciÃ³n de Mappers" en Referencia RÃ¡pida.

**Nota sobre servicios `organization/`:** Van en `service/{dominio}/organization/` sin DTOs propios ni Feign Clients. Ver [servicios-01-creacion-servicios.mdc](./servicios-01-creacion-servicios.mdc)

## ğŸš« Restricciones

1. **NO** mezclar capacidades en la misma carpeta ni usar nombres genÃ©ricos (`common`, `utils`)
2. **NO** organizar por tipo de archivo o tecnologÃ­a (agrupar por capacidad de negocio)
3. **NO** duplicar cÃ³digo entre capacidades (crear servicios compartidos si es necesario)
4. **NO** crear dependencias circulares entre capacidades o subcapacidades
5. **NO** crear estructura profunda (mÃ¡ximo 2 niveles, 3 con subcapacidades)
6. **NO** tener estructura inconsistente entre `service/`, `dto/` y `mapper/`
7. **NO** crear mappers en raÃ­z cuando servicio tiene subcarpetas ni incluir lÃ³gica de negocio en mappers
8. **NO** usar prefijos redundantes en carpetas (`auth/AuthTokenDto` â†’ `auth/TokenDto`)
9. **NO** crear subcapacidades para mÃ©todos pequeÃ±os (< 50 lÃ­neas) o lÃ³gica fuertemente acoplada
10. **NO** omitir `@Component` en mappers ni dejar carpetas vacÃ­as

## âœ… ValidaciÃ³n AutomÃ¡tica

Cursor debe detectar:

- âŒ MÃºltiples capacidades (â‰¥2) en `external/` sin subcarpetas o estructura inconsistente
- âŒ DTOs/Mappers sin reflejar estructura de servicio o mezclados entre capacidades
- âŒ Nombres genÃ©ricos (`folder1`, `common`, `utils`) o imports incorrectos
- âŒ Dependencias circulares entre capacidades o subcapacidades
- âŒ Mappers sin `@Component`, con lÃ³gica de negocio o en raÃ­z incorrecta
- âŒ Subcapacidades < 50 lÃ­neas o servicio coordinador con lÃ³gica de negocio
- âŒ Carpetas vacÃ­as, cÃ³digo duplicado o prefijos redundantes

## ğŸ¯ Objetivo + Regla de Oro

**Objetivo**: Organizar servicios externos, DTOs y Mappers por capacidades de negocio para maximizar cohesiÃ³n, minimizar acoplamiento y facilitar escalabilidad.

**REGLA DE ORO**: "Una capacidad = Una carpeta en `service/`, `dto/` y `mapper/` con estructura paralela. Si â‰¥2 capacidades, usar subcarpetas (`auth/`, `questions/`). Si una capacidad tiene mÃºltiples responsabilidades (>50 lÃ­neas), crear subcapacidades (`validation/rules/`, `validation/storage/`). Coordinador solo delega. Cada cambio afecta solo una carpeta."

---

> **Ver tambiÃ©n**:
> - [servicios-01-creacion-servicios.mdc](./servicios-01-creacion-servicios.mdc) - Arquitectura en capas
> - [servicios-02-feign-client.mdc](./servicios-02-feign-client.mdc) - Feign Clients
> - [servicios-05-dtos.mdc](./servicios-05-dtos.mdc) - Estructura de DTOs
