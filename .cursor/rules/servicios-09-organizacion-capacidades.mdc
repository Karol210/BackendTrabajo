---
description: OrganizaciÃ³n por capacidades en servicios externos, DTOs y Mappers
globs: ["**/service/**/external/**/*.java", "**/dto/**/*.java", "**/mapper/**/*.java"]
alwaysApply: true
---

# ğŸ—‚ï¸ OrganizaciÃ³n por Capacidades - Servicios, DTOs y Mappers

## ğŸ“‹ TL;DR

- âœ… **OBLIGATORIO**: ServiceImpl con â‰¥3 mÃ©todos privados â†’ Separar en `validation/` + `builder/`
- âœ… Estructura paralela: `service/{capacidad}/` â†’ `dto/{capacidad}/` â†’ `mapper/{capacidad}/`
- âœ… Alta cohesiÃ³n por capacidad â€¢ Subcapacidades (>50 lÃ­neas) si son independientes
- âŒ NO mezclar capacidades â€¢ NO mantener mÃ©todos auxiliares privados en ServiceImpl
- âŒ NO estructura inconsistente entre service/dto/mapper

## ğŸš¨ Reglas Principales

1. **SeparaciÃ³n Obligatoria en Servicios CRUD**: Si `ServiceImpl` tiene â‰¥3 mÃ©todos auxiliares privados, separar en capacidades (`validation/`, `builder/`) con interfaces propias
2. **SeparaciÃ³n por Capacidad + Escalabilidad**: Cada capacidad tiene su propia carpeta en `external/`, `dto/` y `mapper/` con nombres descriptivos. Agregar nuevas capacidades sin afectar existentes
3. **CohesiÃ³n Alta**: Todos los archivos relacionados con una capacidad juntos (Client, Service, ServiceImpl, DTOs, Mapper)
4. **Estructura Paralela**: `service/{dominio}/{capacidad}/` se refleja en `dto/{dominio}/{capacidad}/` y `mapper/{dominio}/{capacidad}/`
5. **Subcapacidades**: Para responsabilidades independientes (>50 lÃ­neas), usar subcarpetas (`validation/rules/`, `validation/storage/`)

## ğŸ“Š Referencia RÃ¡pida

### DecisiÃ³n de OrganizaciÃ³n

| Criterio | RaÃ­z `external/` | Subcarpeta `external/{capacidad}/` |
|----------|:----------------:|:---------------------------------:|
| Una sola capacidad | âœ… SÃ­ | âŒ No (sobrecarga innecesaria) |
| MÃºltiples capacidades (â‰¥2) | âŒ No | âœ… SÃ­ (mejor organizaciÃ³n) |
| Capacidades independientes | âŒ No | âœ… SÃ­ (bajo acoplamiento) |
| Funcionalidades relacionadas | âœ… SÃ­ | âŒ No |

### Patrones Comunes de Capacidades

| Capacidad | Responsabilidad | Archivos en carpeta | Archivos en `dto/` | ExposiciÃ³n |
|-----------|-----------------|---------------------|-------------------|:----------:|
| **`validation`** â­ | **Validaciones de negocio (CRUD)** | **`*ValidationService`, `*ValidationServiceImpl`** | **Ninguno (usa DTOs existentes)** | **âŒ Interna** |
| **`builder`** â­ | **ConstrucciÃ³n/transformaciÃ³n (CRUD)** | **`*BuilderService`, `*BuilderServiceImpl`** | **Ninguno (usa DTOs existentes)** | **âŒ Interna** |
| `auth` | AutenticaciÃ³n y autorizaciÃ³n | `*AuthClient`, `*AuthService`, `*AuthServiceImpl` | `*TokenDto`, `*CredentialsDto` | âŒ Interna |
| `questions` | Consulta de datos | `*QuestionsClient`, `*QuestionsService`, `*QuestionsServiceImpl` | `*RequestDto`, `*ResponseDto` | âŒ Interna |
| `validation` | ValidaciÃ³n de reglas (External) | `*ValidationClient`, `*ValidationService`, `*ValidationServiceImpl` | `*ValidationRequestDto`, `*ResultDto` | âŒ Interna |
| `processing` | Procesamiento de transacciones | `*ProcessingClient`, `*ProcessingService`, `*ProcessingServiceImpl` | `*ProcessRequestDto`, `*ProcessResponseDto` | âŒ Interna |
| `storage` | Almacenamiento de datos | `*StorageService`, `*StorageServiceImpl` | Opcional segÃºn caso | âŒ Interna |
| `rules` | Reglas de negocio | `*RulesService`, `*RulesServiceImpl` | Ninguno (usa DTOs existentes) | âŒ Interna |
| `organization` | Ordenar/agrupar datos | `*OrganizationService`, `*OrganizationServiceImpl` | Ninguno (usa DTOs existentes) | âŒ Interna (ver regla 01) |

**â­ CAPACIDADES OBLIGATORIAS**: `validation/` y `builder/` deben crearse cuando un servicio CRUD tiene â‰¥3 mÃ©todos auxiliares privados.

### Subcapacidades - OrganizaciÃ³n Anidada

**CuÃ¡ndo Usar Subcapacidades:**
- âœ… Un mÃ³dulo tiene mÃºltiples responsabilidades bien definidas
- âœ… Cada subcapacidad tiene lÃ³gica significativa (>50 lÃ­neas)
- âœ… Las responsabilidades son independientes entre sÃ­
- âŒ NO crear subcapacidades si solo hay mÃ©todos pequeÃ±os (mantener en un servicio)

| Nivel | Uso | Ejemplo |
|---|---|---|
| **MÃ³dulo Principal** | Coordinador de flujo | `validation/InsurabilityValidationServiceImpl` |
| **Subcapacidad 1** | Responsabilidad especÃ­fica | `validation/rules/InsurabilityValidationRulesServiceImpl` |
| **Subcapacidad 2** | Responsabilidad especÃ­fica | `validation/storage/InsurabilityValidationStorageServiceImpl` |

### OrganizaciÃ³n de Mappers

| UbicaciÃ³n Servicio | UbicaciÃ³n Mapper | Ejemplo |
|-------------------|------------------|---------|
| `service/{dominio}/` | `mapper/{dominio}/` | `service/premiumCalculation/` â†’ `mapper/PremiumCalculationMapper` |
| `service/{dominio}/{capacidad}/` | `mapper/{dominio}/{capacidad}/` | `service/insurability/validation/` â†’ `mapper/insurability/validation/InsurabilityValidationMapper` |
| `service/{dominio}/external/{capacidad}/` | `mapper/{dominio}/{capacidad}/` | `service/insurability/external/auth/` â†’ `mapper/insurability/auth/AuthMapper` |

**Reglas de Mappers:**
- âœ… Mapper sigue la estructura de carpetas del servicio/dominio
- âœ… Nomenclatura: `{Dominio}{Capacidad}Mapper` (ej: `InsurabilityValidationMapper`)
- âœ… AnotaciÃ³n `@Component` para inyecciÃ³n de dependencias
- âœ… MÃ©todos pÃºblicos para transformaciones principales, privados para auxiliares
- âŒ NO crear mappers en raÃ­z de `mapper/` si el servicio tiene subcarpetas
- âŒ NO duplicar lÃ³gica de mapeo entre servicios (crear mapper compartido si es necesario)

### Beneficios de OrganizaciÃ³n por Capacidades

| Beneficio | Impacto |
|-----------|---------|
| **Alta CohesiÃ³n** | Archivos relacionados juntos (`external/auth/` agrupa todo lo de autenticaciÃ³n) |
| **Bajo Acoplamiento** | Cambios en `auth/` no afectan `questions/` |
| **Escalabilidad** | Agregar `validation/` sin tocar cÃ³digo existente |
| **Mantenibilidad** | Desarrolladores encuentran cÃ³digo rÃ¡pidamente |
| **Testing** | Tests separados por capacidad (`AuthServiceTest`, `QuestionsServiceTest`) |

## âœ… Ejemplos

### Ejemplo 1: Estructura Completa por Capacidades - Insurability

```
service/insurability/
â”œâ”€â”€ external/
â”‚   â”œâ”€â”€ auth/                                    ğŸ” Capacidad: AutenticaciÃ³n OAuth2
â”‚   â”‚   â”œâ”€â”€ CognitoAuthClient.java              (Feign Client para Cognito)
â”‚   â”‚   â”œâ”€â”€ CognitoAuthService.java             (Interface)
â”‚   â”‚   â””â”€â”€ CognitoAuthServiceImpl.java         (ImplementaciÃ³n)
â”‚   â”‚
â”‚   â””â”€â”€ questions/                               ğŸ“‹ Capacidad: Consultas de Preguntas
â”‚       â”œâ”€â”€ ExternalInsurabilityQuestionsClient.java
â”‚       â”œâ”€â”€ ExternalInsurabilityQuestionsService.java
â”‚       â””â”€â”€ ExternalInsurabilityQuestionsServiceImpl.java
â”‚
â”œâ”€â”€ organization/                                 ğŸ“Š Capacidad: OrganizaciÃ³n (USO INTERNO)
â”‚   â”œâ”€â”€ InsurabilityQuestionsOrganizationService.java       (Interface)
â”‚   â””â”€â”€ InsurabilityQuestionsOrganizationServiceImpl.java   (ImplementaciÃ³n)
â”‚
â”œâ”€â”€ validation/                                  âœ… Capacidad: ValidaciÃ³n (con subcapacidades)
â”‚   â”œâ”€â”€ InsurabilityValidationService.java      (Interface principal)
â”‚   â”œâ”€â”€ InsurabilityValidationServiceImpl.java  (Coordinador - 68 lÃ­neas)
â”‚   â”‚
â”‚   â”œâ”€â”€ rules/                                   ğŸ“‹ Subcapacidad: Reglas de Negocio
â”‚   â”‚   â”œâ”€â”€ InsurabilityValidationRulesService.java
â”‚   â”‚   â””â”€â”€ InsurabilityValidationRulesServiceImpl.java
â”‚   â”‚
â”‚   â””â”€â”€ storage/                                 ğŸ’¾ Subcapacidad: Almacenamiento
â”‚       â”œâ”€â”€ InsurabilityValidationStorageService.java
â”‚       â””â”€â”€ InsurabilityValidationStorageServiceImpl.java
â”‚
â”œâ”€â”€ InsurabilityQuestionsService.java            (Service Principal)
â””â”€â”€ InsurabilityQuestionsServiceImpl.java        (Orquesta capacidades)

dto/insurability/
â”œâ”€â”€ auth/                                        ğŸ” DTOs de AutenticaciÃ³n
â”‚   â””â”€â”€ CognitoTokenResponseDto.java            (Token OAuth2)
â”‚
â”œâ”€â”€ questions/                                   ğŸ“‹ DTOs de Preguntas
â”‚   â”œâ”€â”€ InsurabilityQuestionsRequestDto.java
â”‚   â”œâ”€â”€ InsurabilityQuestionDto.java
â”‚   â””â”€â”€ InsurabilityQuestionsResponseDto.java
â”‚
â”œâ”€â”€ validation/                                  âœ… DTOs de ValidaciÃ³n
â”‚   â”œâ”€â”€ InsurabilityValidationRequestDto.java
â”‚   â”œâ”€â”€ InsurabilityValidationResponseDto.java
â”‚   â”œâ”€â”€ PersonValidationDto.java
â”‚   â””â”€â”€ QuestionValidationDto.java
â”‚
â””â”€â”€ (raÃ­z)                                       ğŸ’¾ DTOs de Guardar
    â”œâ”€â”€ FormDto.java
    â”œâ”€â”€ InsurabilityRequestDto.java
    â””â”€â”€ InsurabilityResponseDto.java

mapper/insurability/
â”œâ”€â”€ validation/                                  âœ… Mapper de ValidaciÃ³n
â”‚   â””â”€â”€ InsurabilityValidationMapper.java       (Transforma DTOs a estructuras de persistencia)
â”‚
â””â”€â”€ (raÃ­z - si hay mappers generales del dominio)
    â””â”€â”€ InsurabilityMapper.java                 (Transformaciones comunes del dominio)

âš ï¸ NOTA: La capacidad `organization` NO requiere DTOs propios, 
usa los DTOs existentes de otras capacidades.
```

### Ejemplo 2: DecisiÃ³n y Extensibilidad

| Escenario | Estructura | CuÃ¡ndo |
|-----------|------------|--------|
| **Una capacidad** | `external/` raÃ­z | âœ… Simple, una responsabilidad |
| **â‰¥2 capacidades** | `external/auth/`, `external/questions/` | âœ… Mejor organizaciÃ³n |
| **Agregar capacidad** | `external/validation/` | âœ… Sin afectar existentes |

**Extensibilidad en servicio principal:**
```java
@Service
@RequiredArgsConstructor
public class InsurabilityQuestionsServiceImpl implements InsurabilityQuestionsService {
    private final CognitoAuthService cognitoAuthService;              // Existente
    private final ExternalInsurabilityQuestionsService questionsService; // Existente
    private final ExternalValidationService validationService;        // âœ… Nueva capacidad
}
```

### Ejemplo 3: Subcapacidades - Coordinador Delegando

**Estructura:**
```
service/insurability/validation/
â”œâ”€â”€ InsurabilityValidationServiceImpl.java (Coordinador - 68 lÃ­neas)
â”œâ”€â”€ rules/InsurabilityValidationRulesServiceImpl.java (Validaciones)
â””â”€â”€ storage/InsurabilityValidationStorageServiceImpl.java (Persistencia)
```

**Coordinador delega responsabilidades:**
```java
@Service
@RequiredArgsConstructor
public class InsurabilityValidationServiceImpl implements InsurabilityValidationService {
    private final InsurabilityValidationRulesService rulesService;      // âœ… Subcapacidad
    private final InsurabilityValidationStorageService storageService;  // âœ… Subcapacidad
    private final InsurabilityValidationMapper mapper;

    @Override
    public InsurabilityValidationResponseDto validateInsurabilityDeclaration(
            InsurabilityValidationRequestDto request) {
        rulesService.validateRequest(request);                          // âœ… Delega validaciÃ³n
        boolean isInsurable = rulesService.validatePersonsInsurability(request);
        Map<String, Object> stepData = mapper.buildStepData(request.getPersons(), isInsurable);
        storageService.saveValidationStep(stepData);                    // âœ… Delega persistencia
        return InsurabilityValidationResponseDto.builder().insurable(isInsurable).build();
    }
}
```

**Beneficios:** 68 vs 126 lÃ­neas (46% reducciÃ³n), alta cohesiÃ³n, testeable, reutilizable, escalable

### âš ï¸ Caso Especial CRUD: SeparaciÃ³n Obligatoria

**Problema:** `ServiceImpl` con â‰¥3 mÃ©todos auxiliares privados (476 lÃ­neas, 12 mÃ©todos privados)

**SoluciÃ³n:** Separar en capacidades `validation/` + `builder/`

| MÃ©todos Privados | Capacidad Destino |
|------------------|-------------------|
| `validateEmailNotExists()`, `validateDocumentType()`, `validatePasswordNotEmpty()`, `findRoleById()`, `findUserByIdOrThrow()`, `validateUpdateRequest()`, `handleDataIntegrityViolation()` | `validation/UserValidationServiceImpl` (114 lÃ­neas) |
| `buildUserFromRequest()`, `buildSpecification()`, `updateUserFields()` | `builder/UserBuilderServiceImpl` (106 lÃ­neas) |

**Coordinador refactorizado (245 lÃ­neas, CERO mÃ©todos privados):**
```java
@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService {
    private final UserRepository userRepository;
    private final UserMapper userMapper;
    private final UserValidationService validationService;   // âœ… Capacidad
    private final UserBuilderService builderService;         // âœ… Capacidad

    @Override
    @Transactional
    public UserResponseDto createUser(UserRequestDto request) {
        validationService.validateEmailNotExists(request.getEmail());     // âœ… Delega
        validationService.validateDocumentType(request.getDocumentType());// âœ… Delega
        validationService.validatePasswordNotEmpty(request.getPassword());// âœ… Delega
        Role role = validationService.findRoleById(request.getRoleId());  // âœ… Delega
        User user = builderService.buildUserFromRequest(request, role);   // âœ… Delega
        return userMapper.toResponseDto(userRepository.save(user));
    }
    // ... resto mÃ©todos interfaz (8 total) - CERO mÃ©todos privados auxiliares
}
```

**MÃ©tricas:**

| Aspecto | Antes | DespuÃ©s | Mejora |
|---------|-------|---------|--------|
| LÃ­neas ServiceImpl | 476 | 245 | 48% â†“ |
| MÃ©todos privados | 12 | 0 | 100% â†“ |
| Responsabilidades | 3 mezcladas | 1 clara | Alta cohesiÃ³n |

**Criterios obligatorios:**
- ğŸš¨ â‰¥3 mÃ©todos auxiliares â†’ Separar capacidades
- ğŸš¨ ServiceImpl > 300 lÃ­neas â†’ Refactorizar
- âœ… `validate*`, `find*OrThrow` â†’ `validation/`
- âœ… `build*`, `update*Fields` â†’ `builder/`

## ğŸš« Restricciones

1. **NO** mantener â‰¥3 mÃ©todos auxiliares privados en `ServiceImpl` ni mÃ©todos de validaciÃ³n/construcciÃ³n (separar en capacidades OBLIGATORIO)
2. **NO** mezclar capacidades en la misma carpeta ni usar nombres genÃ©ricos (`common`, `utils`) - agrupar por capacidad de negocio
3. **NO** duplicar cÃ³digo entre capacidades ni crear dependencias circulares
4. **NO** crear estructura profunda (mÃ¡ximo 2 niveles, 3 con subcapacidades)
5. **NO** tener estructura inconsistente entre `service/`, `dto/` y `mapper/`
6. **NO** crear mappers en raÃ­z cuando servicio tiene subcarpetas ni incluir lÃ³gica de negocio en mappers
7. **NO** usar prefijos redundantes en carpetas (`auth/AuthTokenDto` â†’ `auth/TokenDto`)
8. **NO** crear subcapacidades para mÃ©todos pequeÃ±os (< 50 lÃ­neas) o lÃ³gica fuertemente acoplada
9. **NO** omitir `@Component` en mappers
10. **NO** dejar carpetas vacÃ­as o cÃ³digo duplicado

## âœ… ValidaciÃ³n AutomÃ¡tica

Cursor debe detectar:

**Servicios CRUD (CRÃTICO):**
- âŒ `ServiceImpl` con â‰¥3 mÃ©todos auxiliares privados sin separar en capacidades
- âŒ MÃ©todos de validaciÃ³n (`validate*`, `find*OrThrow`, `handle*Violation`) en `ServiceImpl`
- âŒ MÃ©todos de construcciÃ³n (`build*`, `update*Fields`) en `ServiceImpl`
- âŒ `ServiceImpl` > 300 lÃ­neas sin refactorizar

**Capacidades External:**
- âŒ MÃºltiples capacidades (â‰¥2) en `external/` sin subcarpetas o estructura inconsistente
- âŒ DTOs/Mappers sin reflejar estructura de servicio o mezclados entre capacidades
- âŒ Nombres genÃ©ricos (`folder1`, `common`, `utils`) o imports incorrectos
- âŒ Dependencias circulares entre capacidades o subcapacidades
- âŒ Mappers sin `@Component`, con lÃ³gica de negocio o en raÃ­z incorrecta
- âŒ Subcapacidades < 50 lÃ­neas o servicio coordinador con lÃ³gica de negocio
- âŒ Carpetas vacÃ­as, cÃ³digo duplicado o prefijos redundantes

## ğŸ¯ Objetivo + Regla de Oro

**Objetivo**: Organizar servicios externos, DTOs y Mappers por capacidades de negocio para maximizar cohesiÃ³n, minimizar acoplamiento y facilitar escalabilidad. **OBLIGATORIO**: Separar capacidades en servicios CRUD con â‰¥3 mÃ©todos auxiliares.

**REGLA DE ORO**: "Una capacidad = Una carpeta. **ServiceImpl con â‰¥3 mÃ©todos privados â†’ SEPARAR en `validation/` + `builder/`**. Si â‰¥2 capacidades external, usar subcarpetas (`auth/`, `questions/`). Si una capacidad tiene mÃºltiples responsabilidades (>50 lÃ­neas), crear subcapacidades (`validation/rules/`, `validation/storage/`). Coordinador solo delega. Cada cambio afecta solo una carpeta."

---

> **Ver tambiÃ©n**:
> - [servicios-01-creacion-servicios.mdc](./servicios-01-creacion-servicios.mdc) - Arquitectura en capas
> - [servicios-02-feign-client.mdc](./servicios-02-feign-client.mdc) - Feign Clients
> - [servicios-05-dtos.mdc](./servicios-05-dtos.mdc) - Estructura de DTOs
