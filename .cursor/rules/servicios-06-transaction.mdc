---
description: CreaciÃ³n de servicios para actualizaciÃ³n de pasos de transacciÃ³n
globs: ["**/service/transaction/**/*.java"]
alwaysApply: true
---

# ðŸ”„ Servicios de TransacciÃ³n - ActualizaciÃ³n de Pasos

## ðŸ“‹ TL;DR

- âœ… NO crear controllers (uso interno Ãºnicamente)
- âœ… Nomenclatura: `{id}` y `{paso}` (NO transactionId/step)
- âœ… Usar servicio base `tienda-seguros` existente
- âœ… DTOs en `dto/transaction/`
- âŒ NO exponer endpoints pÃºblicos

## ðŸš¨ Reglas Principales

1. **Servicios de transacciÃ³n son para uso INTERNO** - NO requieren controller
2. Nomenclatura obligatoria: `{id}` y `{paso}` (NO transactionId/step)
3. Usar servicio base `tienda-seguros.url` (NO crear configuraciÃ³n nueva)
4. Path estÃ¡ndar: `/tienda-seguros/api/v1/transaccion/{id}/paso/{paso}`
5. DTOs con mÃ©todos helper `isSuccess()` y `getErrorMessage()`

## ðŸ“Š Referencia RÃ¡pida

| Elemento | UbicaciÃ³n | Nomenclatura |
|---|---|---|
| DTOs | `dto/transaction/` | `Transaction*Dto` |
| Feign Client | `service/transaction/external/` | `ExternalTransactionStepClient` |
| Servicio External | `service/transaction/external/` | `ExternalTransactionStepService` |
| Servicio Principal | `service/transaction/` | `TransactionStepService` |
| ExcepciÃ³n | `exception/` | `TransactionStepException` |
| ConfiguraciÃ³n | `application.yml` | `services.tienda-seguros.url` |

## âœ… Ejemplos

### Ejemplo 1: Feign Client

```java
@FeignClient(
    name = "tienda-seguros-transaction-client",
    url = "${services.tienda-seguros.url}",  // âœ… Reutiliza servicio existente
    configuration = FeignClientConfig.class
)
public interface ExternalTransactionStepClient {

    /**
     * Actualiza el paso de una transacciÃ³n especÃ­fica.
     *
     * @param id ID de la transacciÃ³n
     * @param paso Nombre del paso a actualizar (ej: "recortarUrl")
     * @param request Datos del paso a actualizar
     * @return Respuesta del servicio externo
     */
    @PutMapping("/tienda-seguros/api/v1/transaccion/{id}/paso/{paso}")  // âœ… Nomenclatura correcta
    TransactionStepResponseDto updateTransactionStep(
        @PathVariable("id") String id,           // âœ… "id", NO "transactionId"
        @PathVariable("paso") String paso,       // âœ… "paso", NO "step"
        @RequestBody TransactionStepRequestDto request
    );
}
```

### Ejemplo 2: Servicio Principal (Uso Interno)

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class TransactionStepServiceImpl implements TransactionStepService {

    private final ExternalTransactionStepService externalTransactionStepService;

    @Override
    public TransactionStepResponseDto updateTransactionStep(
            String id, 
            String paso, 
            TransactionStepRequestDto request) {
        
        log.info("Iniciando actualizaciÃ³n de paso de transacciÃ³n: id={}, paso={}", 
                id, paso);

        try {
            validateRequest(id, paso, request);

            TransactionStepResponseDto response = externalTransactionStepService.updateTransactionStep(
                    id, 
                    paso, 
                    request
            );

            log.info("Paso de transacciÃ³n actualizado exitosamente: id={}, paso={}", 
                    id, paso);

            return response;

        } catch (TransactionStepException e) {
            throw e;
        } catch (Exception e) {
            log.error("Error durante la actualizaciÃ³n del paso de transacciÃ³n: {}", 
                    e.getMessage(), e);
            throw new TransactionStepException(
                Constants.ERROR_TRANSACTION_STEP_UPDATE + ": " + e.getMessage(),
                Constants.CODE_TRANSACTION_STEP_UPDATE_ERROR,
                e
            );
        }
    }
}
```

### Ejemplo 3: Uso desde Otro Servicio

```java
@Service
@RequiredArgsConstructor
public class ShortUrlServiceImpl implements ShortUrlService {

    private final TransactionStepService transactionStepService;

    private void guardarPaso(String id, String urlCorta, Integer dias) {
        TransactionStepRequestDto request = TransactionStepRequestDto.builder()
            .consultas(ConsultasDto.builder()
                .pasarelaPagos(PasarelaPagosDto.builder()
                    .urlCorta(urlCorta)
                    .vigenciaDias(dias)
                    .estado("CREADA")
                    .build())
                .build())
            .build();

        transactionStepService.updateTransactionStep(id, "recortarUrl", request);
    }
}
```

**DTOs**: Ver [servicios-05-dtos.mdc](./servicios-05-dtos.mdc) para estructura estÃ¡ndar. MÃ©todos helper obligatorios: `isSuccess()` y `getErrorMessage()`.

## ðŸš« Restricciones

1. **NO** crear controllers para servicios de transacciÃ³n
2. **NO** exponer endpoints pÃºblicos (`@RestController`)
3. **NO** usar nomenclatura `transactionId` o `step` (usar `id` y `paso`)
4. **NO** crear configuraciÃ³n nueva en `application.yml` (usar `tienda-seguros`)
5. **NO** usar path diferente a `/tienda-seguros/api/v1/transaccion/{id}/paso/{paso}`
6. **NO** omitir validaciÃ³n de respuesta del servicio externo
7. **NO** lanzar excepciones genÃ©ricas sin cÃ³digo de error
8. **NO** omitir logs de operaciones crÃ­ticas
9. **NO** hardcodear URLs del servicio
10. **NO** crear DTOs sin mÃ©todos helper para validaciones

## âœ… ValidaciÃ³n AutomÃ¡tica

Cursor debe detectar:

- âŒ Controller creado para servicios de transacciÃ³n
- âŒ `@RestController` en servicios internos
- âŒ Nomenclatura `transactionId` en lugar de `id`
- âŒ Nomenclatura `step` en lugar de `paso`
- âŒ Nueva configuraciÃ³n `transaction-*` en yml
- âŒ Path diferente al estÃ¡ndar
- âŒ Falta de `@PathVariable` con nombre explÃ­cito
- âŒ Response DTO sin mÃ©todos `isSuccess()` o `getErrorMessage()`
- âŒ Servicio sin validaciÃ³n de entrada

## ðŸŽ¯ Objetivo + Regla de Oro

**Objetivo**: Crear servicios internos para actualizar pasos de transacciÃ³n sin exponer endpoints pÃºblicos, reutilizando infraestructura existente.

**REGLA DE ORO**: "Servicios de transacciÃ³n son INTERNOS (sin controller). Nomenclatura: `{id}` + `{paso}`. Usa `tienda-seguros.url`. Path estÃ¡ndar: `/tienda-seguros/api/v1/transaccion/{id}/paso/{paso}`."

---

## ðŸ“‹ Checklist de CreaciÃ³n

| Fase | VerificaciÃ³n |
|---|---|
| **DiseÃ±o** | Sin controller â€¢ Usa `tienda-seguros.url` â€¢ Nomenclatura `{id}` y `{paso}` |
| **DTOs** | En `dto/transaction/` â€¢ Con mÃ©todos helper â€¢ Ver [servicios-05-dtos.mdc](./servicios-05-dtos.mdc) |
| **Servicios** | Feign Client â€¢ External Service â€¢ Principal Service â€¢ Validaciones |
| **Excepciones** | `TransactionStepException` â€¢ CÃ³digo `TDTC-TX-NNNN` â€¢ Handler en controller |
| **ValidaciÃ³n** | Sin endpoints pÃºblicos â€¢ Logs en operaciones â€¢ Sin errores linter |

## ðŸ“Š Estructura de Archivos

```
src/main/java/com/bolivar/tienda/.../ms/
â”œâ”€â”€ dto/
â”‚   â””â”€â”€ transaction/
â”‚       â”œâ”€â”€ TransactionStepRequestDto.java
â”‚       â”œâ”€â”€ TransactionStepResponseDto.java
â”‚       â”œâ”€â”€ TransactionStepResponseBodyDto.java
â”‚       â”œâ”€â”€ ConsultasDto.java
â”‚       â””â”€â”€ PasarelaPagosDto.java
â”œâ”€â”€ service/
â”‚   â””â”€â”€ transaction/
â”‚       â”œâ”€â”€ TransactionStepService.java (Interface)
â”‚       â”œâ”€â”€ TransactionStepServiceImpl.java (Principal)
â”‚       â””â”€â”€ external/
â”‚           â”œâ”€â”€ ExternalTransactionStepClient.java (Feign)
â”‚           â”œâ”€â”€ ExternalTransactionStepService.java (Interface)
â”‚           â””â”€â”€ ExternalTransactionStepServiceImpl.java
â””â”€â”€ exception/
    â””â”€â”€ TransactionStepException.java
```

## ðŸ”— Referencias

> Ver tambiÃ©n:
> - [servicios-01-creacion-servicios.mdc](./servicios-01-creacion-servicios.mdc) - Arquitectura en capas
> - [servicios-02-feign-client.mdc](./servicios-02-feign-client.mdc) - ConfiguraciÃ³n de Feign Clients
> - [servicios-04-excepciones.mdc](./servicios-04-excepciones.mdc) - Manejo de excepciones
> - [servicios-05-dtos.mdc](./servicios-05-dtos.mdc) - Estructura de DTOs

## ðŸ’¡ Uso ComÃºn

| Caso | Estado | Ejemplo |
|---|---|---|
| **Ã‰xito** | `estado: "CREADA"` | `urlCorta` con valor, `detalleError: null` |
| **Error** | `estado: "ERROR"` | `urlCorta: null`, `detalleError` con mensaje |

**Manejo de errores**: CrÃ­tico â†’ lanzar excepciÃ³n. No crÃ­tico â†’ solo loguear.

**Fechas**: ISO 8601 (`"2025-10-30T14:30:00Z"`) usando `ZonedDateTime.now(ZoneOffset.UTC)`.
